
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meta Invoice â†’ CSV è½‰æ›å™¨</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,300&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0e17; --surface: #131926; --surface2: #1a2233;
    --border: #243049; --text: #e2e8f0; --text-dim: #8899b4;
    --accent: #3b82f6; --accent-glow: rgba(59,130,246,0.25);
    --success: #22c55e; --warn: #f59e0b; --radius: 12px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text);
    min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:40px 20px;
  }
  body::before {
    content:''; position:fixed; inset:0; pointer-events:none;
    background-image: linear-gradient(rgba(59,130,246,0.03) 1px,transparent 1px),
      linear-gradient(90deg,rgba(59,130,246,0.03) 1px,transparent 1px);
    background-size:60px 60px;
  }
  .container { position:relative; z-index:1; max-width:720px; width:100%; }
  header { text-align:center; margin-bottom:36px; }
  header .logo { display:inline-flex; align-items:center; gap:10px; margin-bottom:12px; }
  header .logo-icon {
    width:36px; height:36px; background:linear-gradient(135deg,var(--accent),#6366f1);
    border-radius:10px; display:flex; align-items:center; justify-content:center;
    font-size:18px; box-shadow:0 0 20px var(--accent-glow);
  }
  header h1 { font-size:22px; font-weight:700; letter-spacing:-0.5px; }
  header p { color:var(--text-dim); font-size:14px; margin-top:4px; }
  .settings { display:flex; gap:12px; margin-bottom:20px; }
  .settings label { font-size:12px; color:var(--text-dim); font-weight:500; display:flex; flex-direction:column; gap:6px; flex:1; }
  .settings input {
    background:var(--surface); border:1px solid var(--border); border-radius:8px;
    padding:10px 12px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px; outline:none;
  }
  .settings input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
  .dropzone {
    border:2px dashed var(--border); border-radius:var(--radius); padding:48px 24px;
    text-align:center; cursor:pointer; transition:all 0.3s; background:var(--surface);
    position:relative; overflow:hidden;
  }
  .dropzone::before {
    content:''; position:absolute; inset:0;
    background:radial-gradient(circle at 50% 50%,var(--accent-glow),transparent 70%);
    opacity:0; transition:opacity 0.3s;
  }
  .dropzone:hover,.dropzone.dragover { border-color:var(--accent); background:var(--surface2); }
  .dropzone:hover::before,.dropzone.dragover::before { opacity:1; }
  .dropzone-icon { font-size:40px; margin-bottom:12px; position:relative; }
  .dropzone h3 { font-size:16px; font-weight:500; margin-bottom:6px; position:relative; }
  .dropzone p { font-size:13px; color:var(--text-dim); position:relative; }
  .dropzone input[type="file"] { display:none; }
  .file-list { margin-top:20px; display:flex; flex-direction:column; gap:6px; }
  .file-item {
    display:flex; align-items:center; gap:10px; padding:10px 14px;
    background:var(--surface); border:1px solid var(--border); border-radius:8px;
    font-size:13px; font-family:'JetBrains Mono',monospace;
    animation:fadeIn 0.3s ease forwards; opacity:0;
  }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .file-item .name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .file-item .size { color:var(--text-dim); font-size:12px; }
  .file-item .remove {
    background:none; border:none; color:var(--text-dim); cursor:pointer;
    font-size:16px; padding:2px 6px; border-radius:4px;
  }
  .file-item .remove:hover { color:#f87171; background:rgba(248,113,113,0.1); }
  .convert-btn {
    margin-top:24px; width:100%; padding:14px; font-size:15px; font-weight:600;
    font-family:'DM Sans',sans-serif; border:none; border-radius:var(--radius); cursor:pointer;
    background:linear-gradient(135deg,var(--accent),#6366f1); color:white;
    box-shadow:0 4px 20px var(--accent-glow); transition:all 0.25s;
  }
  .convert-btn:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 6px 30px rgba(59,130,246,0.4); }
  .convert-btn:disabled { opacity:0.4; cursor:not-allowed; box-shadow:none; }
  .convert-btn.processing { background:var(--surface2); border:1px solid var(--border); color:var(--text-dim); }
  .results { margin-top:24px; animation:fadeIn 0.4s ease forwards; }
  .results h3 { font-size:14px; font-weight:600; margin-bottom:12px; color:var(--success); display:flex; align-items:center; gap:8px; }
  .download-row { display:flex; gap:10px; margin-bottom:8px; }
  .download-btn {
    flex:1; padding:12px 16px; background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); color:var(--text); font-family:'DM Sans',sans-serif;
    font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s;
    text-decoration:none; text-align:center; display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .download-btn:hover { border-color:var(--accent); background:var(--surface2); box-shadow:0 0 0 3px var(--accent-glow); }
  .stats { display:flex; gap:12px; margin-top:12px; }
  .stat { flex:1; padding:14px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); text-align:center; }
  .stat .num { font-size:22px; font-weight:700; font-family:'JetBrains Mono',monospace; color:var(--accent); }
  .stat .label { font-size:11px; color:var(--text-dim); margin-top:2px; text-transform:uppercase; letter-spacing:0.5px; }
  .log {
    margin-top:16px; padding:14px; background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); font-family:'JetBrains Mono',monospace; font-size:12px;
    max-height:200px; overflow-y:auto; color:var(--text-dim); line-height:1.8;
  }
  .log .ok { color:var(--success); } .log .err { color:#f87171; } .log .warn { color:var(--warn); }
  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo"><div class="logo-icon">ğŸ“„</div><h1>Meta Invoice â†’ CSV</h1></div>
    <p>æ‹–å…¥ Meta Ads PDF Invoiceï¼Œè‡ªå‹•ç”¢ç”Ÿ Overview åŠ Detail CSV</p>
  </header>
  <div class="settings">
    <label>ä¿¡ç”¨å¡æŒæœ‰äºº<input type="text" id="cardOwner" value="Your Name" /></label>
  </div>
  <div class="dropzone" id="dropzone">
    <div class="dropzone-icon">ğŸ“‚</div>
    <h3>æ‹–æ”¾ PDF æª”æ¡ˆåˆ°é€™è£¡</h3>
    <p>æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆï¼ˆæ”¯æ´å¤šé¸ï¼‰</p>
    <input type="file" id="fileInput" multiple accept=".pdf" />
  </div>
  <div class="file-list" id="fileList"></div>
  <button class="convert-btn" id="convertBtn" disabled>è½‰æ›ç‚º CSV</button>
  <div id="resultsArea"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const pdfFiles = [];
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const convertBtn = document.getElementById('convertBtn');
const resultsArea = document.getElementById('resultsArea');

dropzone.addEventListener('click', () => fileInput.click());
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('dragover'); addFiles(e.dataTransfer.files); });
fileInput.addEventListener('change', () => { addFiles(fileInput.files); fileInput.value = ''; });
convertBtn.addEventListener('click', runConvert);

function addFiles(files) {
  for (const f of files) {
    if (!f.name.toLowerCase().endsWith('.pdf')) continue;
    if (pdfFiles.some(p => p.name === f.name)) continue;
    pdfFiles.push(f);
  }
  renderFileList();
}
function removeFile(idx) { pdfFiles.splice(idx, 1); renderFileList(); }
function renderFileList() {
  fileList.innerHTML = '';
  pdfFiles.forEach((f, i) => {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.style.animationDelay = `${i*0.04}s`;
    div.innerHTML = `<span>ğŸ“„</span><span class="name">${f.name}</span><span class="size">${(f.size/1024).toFixed(0)} KB</span><button class="remove" onclick="removeFile(${i})">âœ•</button>`;
    fileList.appendChild(div);
  });
  convertBtn.disabled = pdfFiles.length === 0;
  resultsArea.innerHTML = '';
}

async function extractTextFromPDF(file) {
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  let fullText = '';
  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const items = content.items.filter(it => it.str.trim() !== '');
    if (!items.length) continue;
    items.sort((a, b) => {
      const dy = b.transform[5] - a.transform[5];
      if (Math.abs(dy) > 3) return dy;
      return a.transform[4] - b.transform[4];
    });
    const lines = [];
    let cur = [items[0]];
    for (let i = 1; i < items.length; i++) {
      if (Math.abs(cur[0].transform[5] - items[i].transform[5]) < 3) {
        cur.push(items[i]);
      } else {
        lines.push(cur); cur = [items[i]];
      }
    }
    lines.push(cur);
    for (const line of lines) {
      line.sort((a, b) => a.transform[4] - b.transform[4]);
      let txt = '';
      for (let i = 0; i < line.length; i++) {
        if (i > 0) {
          const gap = line[i].transform[4] - (line[i-1].transform[4] + (line[i-1].width || 0));
          txt += gap > 4 ? ' ' : '';
        }
        txt += line[i].str;
      }
      fullText += txt.trim() + '\n';
    }
  }
  return fullText;
}

function parseInvoice(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
  let invoiceDate = null, paymentMethod = null, transactionId = null, paidAmount = null;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (!invoiceDate) {
      const dm = line.match(/((?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},\s+\d{4},?\s+\d{1,2}:\d{2}\s*(?:AM|PM))/i);
      if (dm) invoiceDate = dm[1];
    }
    const pmMatch = line.match(/((?:Visa|MasterCard|American Express)\s+[Â·â€¢â‹¯â€¦\s\d]+\d{4})/);
    if (pmMatch) {
      paymentMethod = pmMatch[1].replace(/[Â·â€¢â‹¯â€¦]+\s*/g, 'Â· ').replace(/\s+Â·\s+/g, ' Â· ').replace(/\s+/g, ' ').trim();
    }
    const tidMatch = line.match(/(\d{15,}-\d{15,})/);
    if (tidMatch) transactionId = tidMatch[1];
    const amtMatch = line.match(/HK\$([\d,]+\.\d{2})\s*HKD/);
    if (amtMatch && !paidAmount) {
      paidAmount = parseFloat(amtMatch[1].replace(/,/g, ''));
    }
  }

  const campaigns = parseCampaigns(lines);
  if (!invoiceDate || paidAmount == null) return null;
  return { invoiceDate, transactionId, paymentMethod, invoiceAmount: paidAmount, currency: 'HKD', campaigns };
}

function parseCampaigns(lines) {
  const campaigns = [];
  let startIdx = -1;
  for (let i = 0; i < lines.length; i++) {
    if (lines[i] === 'Campaigns') { startIdx = i + 1; break; }
  }
  if (startIdx < 0) return campaigns;

  let endIdx = lines.length;
  for (let i = startIdx; i < lines.length; i++) {
    if (lines[i].includes('Meta Platforms Ireland')) { endIdx = i; break; }
  }

  const skip = ['Powered by TCPDF', 'Invoice #', 'VAT Reg', 'Dublin', 'D04', 'Ireland', 'Merrion', 'Hong Kong'];
  const adSetRe = /^(.+?)[\s.]([\d,]+)\s+(?:Impressions?|Video Views?|Link clicks?)\s+HK\$([\d,]+\.?\d*)$/;
  const subtotalRe = /^HK\$[\d,]+\.?\d*$/;

  let currentCampaign = null;
  for (let i = startIdx; i < endIdx; i++) {
    const line = lines[i];
    if (skip.some(k => line.includes(k))) continue;
    if (/^From\s/.test(line)) continue;
    if (subtotalRe.test(line)) continue;
    const m = adSetRe.exec(line);
    if (m) {
      if (currentCampaign) {
        campaigns.push({ campaignName: currentCampaign, adSetName: m[1].trim(), amount: parseFloat(m[3].replace(/,/g, '')) });
      }
      continue;
    }
    currentCampaign = line;
  }
  return campaigns;
}

function parseInvDate(s) {
  const m = s.match(/(\w+)\s+(\d+),\s+(\d{4})/);
  return m ? new Date(`${m[1]} ${m[2]}, ${m[3]}`) : null;
}
function fmtDate(dt) {
  const M = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${dt.getDate()} ${M[dt.getMonth()]} ${dt.getFullYear()}`;
}
function fmtNum(n) {
  let s = n.toFixed(2);
  if (s.includes('.')) s = s.replace(/0+$/, '').replace(/\.$/, '');
  return s;
}
function fmtActual(amount, method) {
  if (method && method.includes('American Express')) return fmtNum(amount);
  let s = (amount * 1.01).toFixed(4);
  if (s.includes('.')) s = s.replace(/0+$/, '').replace(/\.$/, '');
  return s;
}

/**
 * Page åˆ†é¡è¦å‰‡ï¼ˆæŒ‰å„ªå…ˆé †åºï¼‰:
 *   1. profile_visit â†’ "LJ IG"
 *   2. lj           â†’ "LJ FB"
 *   3. edu          â†’ "EDU"
 *   4. health       â†’ "Health"
 *   5. event        â†’ "Event"
 *   6. subscription â†’ "Subscription"
 *   7. ä»¥ä¸Šéƒ½ä¸åŒ¹é…  â†’ ""
 */
function determinePage(campaignName) {
  const t = campaignName.toLowerCase();
  if (t.includes('profile_visit')) return 'LJ IG';
  if (t.includes('lj')) return 'LJ FB';
  if (t.includes('edu')) return 'EDU';
  if (t.includes('health')) return 'Health';
  if (t.includes('event')) return 'Event';
  if (t.includes('subscription')) return 'Subscription';
  return '';
}

function toCSV(rows) {
  return rows.map(r => r.map(c => {
    const s = String(c);
    return (s.includes(',') || s.includes('"') || s.includes('\n')) ? '"' + s.replace(/"/g, '""') + '"' : s;
  }).join(',')).join('\r\n');
}

async function runConvert() {
  convertBtn.disabled = true;
  convertBtn.textContent = 'è™•ç†ä¸­...';
  convertBtn.classList.add('processing');
  resultsArea.innerHTML = '';

  const cardOwner = document.getElementById('cardOwner').value || 'Your Name';
  const logLines = [];
  const log = (msg, cls = '') => logLines.push({ msg, cls });
  const invoices = [];

  for (const file of pdfFiles) {
    try {
      const text = await extractTextFromPDF(file);
      const inv = parseInvoice(text);
      if (inv && inv.campaigns.length > 0) {
        inv._source = file.name;
        invoices.push(inv);
        log(`âœ“ ${file.name} â€” ${inv.campaigns.length} ad sets`, 'ok');
      } else if (inv) {
        log(`âš  ${file.name} â€” å·²è§£æä½†æœªæ‰¾åˆ° campaign æ˜ç´°`, 'warn');
      } else {
        log(`âš  ç„¡æ³•è§£æ: ${file.name}`, 'warn');
      }
    } catch (e) {
      log(`âœ— éŒ¯èª¤: ${file.name} â€” ${e.message}`, 'err');
    }
  }

  invoices.sort((a, b) => parseInvDate(a.invoiceDate) - parseInvDate(b.invoiceDate));

  /* Overview CSV */
  const oRows = [['Form submit date','Invoice Date','Transaction ID','Payment method','Who is the card owner?','Invoice Amount','Currency','Actual Payment']];
  for (const inv of invoices) {
    const dt = parseInvDate(inv.invoiceDate);
    oRows.push(['', fmtDate(dt), inv.transactionId || '', inv.paymentMethod || '', cardOwner, fmtNum(inv.invoiceAmount), inv.currency, fmtActual(inv.invoiceAmount, inv.paymentMethod)]);
  }

  /* Detail CSV */
  let detailCount = 0;
  const dRows = [['Form submit date','Invoice date','Campaign Name','Page','Campaign Amount']];
  for (const inv of invoices) {
    const dt = parseInvDate(inv.invoiceDate);
    const ds = fmtDate(dt);
    for (const c of inv.campaigns) {
      dRows.push(['', ds, c.campaignName, determinePage(c.campaignName), 'HK$' + fmtNum(c.amount)]);
      detailCount++;
    }
  }

  log('', '');
  log(`å®Œæˆï¼ ${invoices.length} å¼µ invoice, ${detailCount} è¡Œæ˜ç´°`, 'ok');

  const oBlob = new Blob(['\ufeff' + toCSV(oRows)], { type: 'text/csv;charset=utf-8' });
  const dBlob = new Blob(['\ufeff' + toCSV(dRows)], { type: 'text/csv;charset=utf-8' });

  resultsArea.innerHTML = `
    <div class="results">
      <h3>âœ… è½‰æ›å®Œæˆ</h3>
      <div class="download-row">
        <a class="download-btn" href="${URL.createObjectURL(oBlob)}" download="Overview.csv">ğŸ“Š ä¸‹è¼‰ Overview CSV</a>
        <a class="download-btn" href="${URL.createObjectURL(dBlob)}" download="Detail.csv">ğŸ“‹ ä¸‹è¼‰ Detail CSV</a>
      </div>
      <div class="stats">
        <div class="stat"><div class="num">${invoices.length}</div><div class="label">Invoices</div></div>
        <div class="stat"><div class="num">${detailCount}</div><div class="label">Ad Sets</div></div>
        <div class="stat"><div class="num">HK$${fmtNum(invoices.reduce((s,i) => s + i.invoiceAmount, 0))}</div><div class="label">Total</div></div>
      </div>
      <div class="log">${logLines.map(l => `<div class="${l.cls}">${l.msg}</div>`).join('')}</div>
    </div>`;

  convertBtn.textContent = 'è½‰æ›ç‚º CSV';
  convertBtn.classList.remove('processing');
  convertBtn.disabled = false;
}
</script>
</body>
</html>
